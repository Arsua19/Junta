<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cliente Sabina - Cobros Mensuales</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>Cliente: Sabina (Cobro Mensual)</h2>

  <label for="monto">Monto (S/):</label>
  <input type="number" id="monto" required>
  <button onclick="registrarPago()">Registrar Pago</button>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Monto (S/)</th>
        <th>Días Pagados</th>
      </tr>
    </thead>
    <tbody id="tabla-registros"></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th id="total-monto">0</th>
        <th id="total-dias">0</th>
      </tr>
    </tfoot>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const cliente = "Sabina";

    async function registrarPago() {
      const monto = parseFloat(document.getElementById("monto").value);
      if (!monto) return alert("Ingrese un monto");

      const hoy = new Date();
      const mesActual = hoy.getMonth();
      const añoActual = hoy.getFullYear();

      const registros = await db.collection("registrosCobro")
        .where("cliente", "==", cliente)
        .get();

      const yaPagoEsteMes = registros.docs.some(doc => {
        const data = doc.data();
        const fecha = data.fecha.toDate();
        return fecha.getMonth() === mesActual && fecha.getFullYear() === añoActual;
      });

      if (yaPagoEsteMes) {
        alert("Ya se registró un pago este mes.");
        return;
      }

      const diasPagados = monto / 20;
      await db.collection("registrosCobro").add({
        cliente,
        fecha: firebase.firestore.Timestamp.fromDate(hoy),
        monto,
        diasPagados
      });

      document.getElementById("monto").value = "";
      cargarRegistros();
    }

    async function cargarRegistros() {
      const tabla = document.getElementById("tabla-registros");
      tabla.innerHTML = "";

      const registros = await db.collection("registrosCobro")
        .where("cliente", "==", cliente)
        .orderBy("fecha", "desc")
        .get();

      let totalMonto = 0;
      let totalDias = 0;

      registros.forEach(doc => {
        const data = doc.data();
        const fecha = data.fecha.toDate().toLocaleDateString();
        const monto = data.monto.toFixed(2);
        const dias = data.diasPagados;

        totalMonto += parseFloat(data.monto);
        totalDias += dias;

        const fila = `
          <tr>
            <td>${fecha}</td>
            <td>${monto}</td>
            <td>${dias}</td>
          </tr>`;
        tabla.innerHTML += fila;
      });

      document.getElementById("total-monto").textContent = totalMonto.toFixed(2);
      document.getElementById("total-dias").textContent = totalDias;
    }

    cargarRegistros();
  </script>
</body>
</html>
